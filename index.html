
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Tr√≤ Ch∆°i Ph√¢n Bi·ªát C√°c Cu·ªôc C√°ch M·∫°ng C√¥ng Nghi·ªáp 1.0‚Äì3.0 | Educational Game: Industrial Revolutions</title>
<meta name="description" content="Tr√≤ ch∆°i ph√¢n bi·ªát c√°c cu·ªôc C√°ch m·∫°ng c√¥ng nghi·ªáp 1.0‚Äì3.0. Giao di·ªán t·ªëi sang tr·ªçng, b·∫£ng s√°ng n·ªïi b·∫≠t, ƒë√°p √°n random, t√≠nh gi·ªù, ch·∫•m ƒëi·ªÉm, t·ªëi ∆∞u TV 4K." />

<style>
:root{
  --bg: #0c111b;
  --panel: #ffffff;
  --primary: #ff8a00;
  --secondary: #1e88e5;
  --ok: #2e7d32;
  --bad: #d32f2f;
  --border: #e0e6ed;
  --text-main: #e3e8f5;
  --text-sub: #90a4ae;
  --radius: 18px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:linear-gradient(180deg,#0c111b 0%,#111827 100%);
  color:var(--text-main);
  font-family:-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  user-select:none;
  -webkit-font-smoothing:antialiased;
}
.app{min-height:100vh;display:grid;grid-template-rows:auto auto 1fr auto;gap:20px;padding:clamp(16px,2vw,28px)}

header{
  display:flex;justify-content:space-between;align-items:center;gap:20px;
  background:#0f172a;border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);
  padding:clamp(14px,1.8vw,24px);
  box-shadow:0 10px 40px rgba(0,0,0,.5);
}
.brand{display:flex;align-items:center;gap:16px}
.logo{
  width:clamp(36px,3vw,48px);height:clamp(36px,3vw,48px);
  border-radius:12px;
  background:conic-gradient(from 210deg,var(--primary),#ffd180 30%, #64b5f6 70%, var(--secondary));
  box-shadow:0 0 30px rgba(255,138,0,.5);
}
.title h1{
  margin:0;font-size:clamp(26px,3vw,48px);font-weight:800;letter-spacing:.3px;
  background:linear-gradient(90deg,#ffb300,#ff8a00,#64b5f6);
  -webkit-background-clip:text;color:transparent;text-transform:uppercase;
}
.title h2{
  margin:6px 0 0;font-size:clamp(16px,1.2vw,20px);color:#90caf9;font-style:italic;
}

nav{display:flex;flex-wrap:wrap;gap:clamp(8px,1vw,14px)}
.btn{
  font-size:clamp(16px,1.3vw,22px);padding:.7em 1.1em;border-radius:10px;border:none;cursor:pointer;
  transition:.15s;box-shadow:0 4px 16px rgba(0,0,0,.25);
}
.btn.primary{background:linear-gradient(180deg,#ff9800,#ff6f00);color:#fff}
.btn.secondary{background:linear-gradient(180deg,#2196f3,#1565c0);color:#fff}
.btn.success{background:linear-gradient(180deg,#43a047,#2e7d32);color:#fff}
.btn.light{background:#fff;color:#111827}
.btn.warn{background:linear-gradient(180deg,#ef5350,#c62828);color:#fff}
.btn:hover{transform:translateY(-2px);filter:brightness(1.1)}

.status{
  display:flex;justify-content:space-between;align-items:center;
  background:#0f172a;border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius);padding:clamp(12px,1.4vw,20px);
  box-shadow:0 6px 24px rgba(0,0,0,.4);
}
.timer{font-size:clamp(20px,1.8vw,28px);font-weight:700;color:#ffb300}
.score{font-size:clamp(20px,1.8vw,28px);font-weight:700;color:#81c784}

.card{
  background:var(--panel);border-radius:var(--radius);
  box-shadow:0 20px 60px rgba(0,0,0,.6);overflow:hidden;color:#111;
}
.table-wrap{overflow:auto;border-radius:var(--radius)}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:clamp(16px,1.3vw,22px)}
th,td{padding:clamp(10px,1vw,16px);border-bottom:1px solid var(--border);border-right:1px solid var(--border)}
thead th{background:var(--secondary);color:#fff;font-weight:700;text-transform:uppercase}
tbody td:first-child{background:#fff3e0;color:#bf360c;font-weight:700}
td.select{cursor:pointer;text-align:center;color:#424242}
td.select.placeholder{color:#9e9e9e;font-style:italic}
tr:hover td.select{background:#f5f8ff}
.correct{background:#e8f5e9 !important;outline:2px solid #81c784}
.wrong{background:#ffebee !important;outline:2px solid #ef9a9a}

/* Menu x·ªï ƒë√°p √°n */
.menu{
  position:fixed;z-index:1000;display:none;
  min-width:clamp(280px,32vw,560px);max-height:min(65vh,560px);overflow:auto;
  background:#ffffff;border-radius:16px;border:1px solid #dbe2ec;
  box-shadow:0 30px 90px rgba(0,0,0,.6);
}
.menu h4{margin:12px 14px 10px;font-size:clamp(16px,1.4vw,22px);color:#0c111b}
.opt{padding:14px 16px;cursor:pointer;border-top:1px solid #f0f3f8;background:#fff;font-size:clamp(16px,1.2vw,20px);color:#212121}
.opt:first-of-type{border-top:none}
.opt:hover{background:#fff8e1;outline:2px solid #ffe082}
.actions{display:flex;gap:10px;padding:12px;border-top:1px solid #f0f3f8}
.chip{padding:10px 12px;border-radius:10px;background:#fafafa;color:#37474f;border:1px solid #dbe2ec;cursor:pointer}
.chip:hover{background:#f0f0f0}

/* Footer */
footer{
  background:#ffffff;
  color:#0d47a1;
  font-weight:700;
  font-size:clamp(18px,1.8vw,24px);
  text-align:center;
  padding:18px 10px;
  border-radius:var(--radius);
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
}
footer span{color:#ff6f00}

/* Modal chung */
.modal{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.8);z-index:2000;visibility:hidden;opacity:0;transition:.25s ease;
}
.modal.active{visibility:visible;opacity:1}
.modal-box{
  background:#fff;padding:22px 26px;border-radius:16px;text-align:center;max-width:640px;width:92%;
  box-shadow:0 30px 90px rgba(0,0,0,.6);
}
.modal-box h2{margin:0 0 8px;color:#0d47a1}

/* Modal Nh·∫≠p T√™n */
#playerName{
  width:100%;padding:12px;font-size:20px;margin:10px 0 6px;border-radius:10px;border:1px solid #cfd8dc;text-align:center;
}
.virtual-keys{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:8px}
.key{background:#eeeeee;border:none;padding:10px;font-size:16px;border-radius:8px;cursor:pointer}
.key:active{background:#dcdcdc}
#btnConfirmName{margin-top:12px;padding:10px 16px;border:none;border-radius:10px;background:#ff9800;color:#fff;font-size:18px;cursor:pointer}

/* B·∫£ng x·∫øp h·∫°ng n·ªïi */
#leaderboard{
  position:fixed;right:16px;bottom:16px;z-index:1200;background:#ffffff;color:#111;padding:12px 14px;border-radius:14px;
  min-width:260px;max-width:28vw;box-shadow:0 10px 40px rgba(0,0,0,.35);border:1px solid #e0e6ed;
}
#leaderboard h3{margin:0 0 8px;text-align:center;color:#0d47a1}
.rank{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eceff1;padding:6px 0;font-size:16px}
.rank:last-child{border-bottom:none}
.rank .name{font-weight:600}
.rank .meta{color:#455a64}
.muted{opacity:.65}

/* Kh√≥a click khi ch∆∞a b·∫Øt ƒë·∫ßu */
.locked td.select{pointer-events:none;opacity:.6}

/* A11y: v√πng th√¥ng b√°o */
.sr-live{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>

<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <h1>Tr√≤ Ch∆°i Ph√¢n Bi·ªát C√°c Cu·ªôc C√°ch M·∫°ng C√¥ng Nghi·ªáp T·ª´ 1.0 ƒë·∫øn 3.0</h1>
        <h2>Educational Game: Industrial Revolutions 1.0 ‚Äì 3.0</h2>
      </div>
    </div>
    <nav>
      <button id="btnFs" class="btn light" aria-label="B·∫≠t to√†n m√†n h√¨nh">‚õ∂ Fullscreen</button>
      <button id="btnStart" class="btn primary">‚ñ∂ B·∫Øt ƒë·∫ßu</button>
      <button id="btnCheck" class="btn success">‚úÖ N·ªôp b√†i</button>
      <button id="btnShow" class="btn secondary">üß© ƒê√°p √°n m·∫´u</button>
      <button id="btnReset" class="btn light">üßº Reset</button>
      <!-- B·ªï sung y√™u c·∫ßu -->
      <button id="btnNewPlayer" class="btn light">üë§ Ng∆∞·ªùi ch∆°i m·ªõi</button>
      <button id="btnHistory" class="btn light">üìú L·ªãch s·ª≠</button>
      <button id="btnClearLB" class="btn warn">üóëÔ∏è X√≥a BXH</button>
    </nav>
  </header>

  <section class="status">
    <div id="timer" class="timer" aria-live="polite">üïí 00:00</div>
    <div id="score" class="score" aria-live="polite">ƒêi·ªÉm: ‚Äî</div>
  </section>

  <main>
    <article class="card table-wrap">
      <table id="tbl" class="locked" aria-label="B·∫£ng gh√©p ti√™u ch√≠ c√°c cu·ªôc c√°ch m·∫°ng c√¥ng nghi·ªáp">
        <thead>
          <tr>
            <th>Ti√™u ch√≠</th>
            <th>CMCN 1.0</th>
            <th>CMCN 2.0</th>
            <th>CMCN 3.0</th>
          </tr>
        </thead>
        <tbody>
          <tr data-row="time"><td>Th·ªùi gian</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td></tr>
          <tr data-row="context"><td>B·ªëi c·∫£nh ra ƒë·ªùi</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td></tr>
          <tr data-row="energy"><td>Ngu·ªìn nƒÉng l∆∞·ª£ng ch·ªß ƒë·∫°o</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td></tr>
          <tr data-row="tech"><td>C√¥ng ngh·ªá ti√™u bi·ªÉu</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td></tr>
          <tr data-row="field"><td>Lƒ©nh v·ª±c n·ªïi b·∫≠t</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td></tr>
          <tr data-row="keyword"><td>T·ª´ kh√≥a ƒë·∫∑c tr∆∞ng</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td></tr>
          <tr data-row="achievement"><td>Th√†nh t·ª±u ti√™u bi·ªÉu</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td></tr>
          <tr data-row="impact"><td>·∫¢nh h∆∞·ªüng ch√≠nh</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td><td class="select placeholder" tabindex="0">Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ</td></tr>
        </tbody>
      </table>
    </article>
  </main>

  <section id="leaderboard" aria-label="B·∫£ng x·∫øp h·∫°ng">
    <h3>üèÜ X·∫øp h·∫°ng</h3>
    <div id="rankList"></div>
    <div class="muted" style="font-size:12px;margin-top:6px;">L∆∞u c·ª•c b·ªô (LocalStorage)</div>
  </section>

  <footer>Thi·∫øt k·∫ø b·ªüi: <span>Nguy·ªÖn VƒÉn An</span> ‚Äì Tr∆∞·ªùng THPT chuy√™n L√™ H·ªìng Phong TP.HCM</footer>
</div>

<!-- Modal nh·∫≠p t√™n ng∆∞·ªùi ch∆°i -->
<div id="playerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="playerTitle">
  <div class="modal-box">
    <h2 id="playerTitle">Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i</h2>
    <input id="playerName" type="text" placeholder="Nh·∫≠p t√™n..." autocomplete="off" aria-label="T√™n ng∆∞·ªùi ch∆°i">
    <div class="virtual-keys" id="virtualKeyboard" aria-hidden="false"></div>
    <button id="btnConfirmName">OK</button>
  </div>
</div>

<!-- Modal Review -->
<div id="reviewModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="reviewTitle">
  <div class="modal-box">
    <h2 id="reviewTitle">üéâ K·∫øt qu·∫£ l∆∞·ª£t ch∆°i</h2>
    <p id="reviewText" style="margin:8px 0 16px;color:#37474f"></p>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
      <button id="btnReviewClose" class="btn light">ƒê√≥ng</button>
      <button id="btnReviewNew" class="btn primary">üë§ Ng∆∞·ªùi ch∆°i m·ªõi</button>
      <button id="btnReviewHistory" class="btn secondary">üìú L·ªãch s·ª≠</button>
    </div>
    <div class="muted" style="margin-top:10px;font-size:12px">B·∫°n c√≥ th·ªÉ xem chi ti·∫øt ƒë√∫ng/sai ngay tr√™n b·∫£ng hi·ªán t·∫°i.</div>
  </div>
</div>

<!-- Modal L·ªãch s·ª≠ -->
<div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
  <div class="modal-box">
    <h2 id="historyTitle">üìú L·ªãch s·ª≠ & B·∫£ng x·∫øp h·∫°ng ƒë·∫ßy ƒë·ªß</h2>
    <div id="historyList" style="max-height:52vh;overflow:auto;text-align:left"></div>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
      <button id="btnHistoryClose" class="btn light">ƒê√≥ng</button>
    </div>
  </div>
</div>

<!-- ARIA live v√πng ·∫©n cho th√¥ng b√°o -->
<div class="sr-live" aria-live="polite" id="liveRegion"></div>

<div id="menu" class="menu" role="listbox" aria-label="Ch·ªçn n·ªôi dung"></div>

<script>
/* ========= D·ªÆ LI·ªÜU G·ªêC ========= */
const ANSWERS={
  time:["Cu·ªëi th·∫ø k·ª∑ XVIII ‚Äì ƒë·∫ßu XIX","Cu·ªëi XIX ‚Äì ƒë·∫ßu XX (1914)","N·ª≠a sau th·∫ø k·ª∑ XX"],
  context:["Nhu c·∫ßu tƒÉng nƒÉng su·∫•t s·∫£n xu·∫•t th·ªß c√¥ng ·ªü Anh","Ph√°t tri·ªÉn t∆∞ b·∫£n ƒë·ªôc quy·ªÅn, ƒë√¥ th·ªã h√≥a, to√†n c·∫ßu h√≥a","H·∫≠u Th·∫ø chi·∫øn II, b√πng n·ªï khoa h·ªçc ‚Äì c√¥ng ngh·ªá"],
  energy:["H∆°i n∆∞·ªõc, than ƒë√°","ƒêi·ªán, d·∫ßu m·ªè","ƒêi·ªán t·ª≠, h·∫°t nh√¢n"],
  tech:["M√°y h∆°i n∆∞·ªõc, c∆° kh√≠ h√≥a","D√¢y chuy·ªÅn ƒëi·ªán, ƒë·ªông c∆° ƒë·ªët trong","M√°y t√≠nh, Internet, t·ª± ƒë·ªông h√≥a"],
  field:["C∆° kh√≠, d·ªát, khai kho√°ng","√î t√¥, h√≥a d·∫ßu, th√©p, vi·ªÖn th√¥ng","ƒêi·ªán t·ª≠, tin h·ªçc, sinh h·ªçc"],
  keyword:["C∆° gi·ªõi h√≥a","ƒêi·ªán kh√≠ h√≥a","T·ª± ƒë·ªông h√≥a"],
  achievement:["M√°y h∆°i n∆∞·ªõc (James Watt)","D√¢y chuy·ªÅn s·∫£n xu·∫•t (Ford)","M√°y t√≠nh ‚Äì Internet"],
  impact:["Thay ƒë·ªïi s·∫£n xu·∫•t th·ªß c√¥ng ‚Üí c∆° kh√≠","S·∫£n xu·∫•t h√†ng lo·∫°t, nƒÉng su·∫•t cao","S·ªë h√≥a th√¥ng tin, to√†n c·∫ßu h√≥a"]
};
const DISTRACTORS={
  time:["ƒê·∫ßu th·∫ø k·ª∑ XXI (sau 2000)","Gi·ªØa th·∫ø k·ª∑ XVIII","Th·∫ø k·ª∑ XVII"],
  context:["Kh·ªßng ho·∫£ng d·∫ßu m·ªè 1973","Kh·ªßng ho·∫£ng t√†i ch√≠nh 2008","ƒê·∫°i kh·ªßng ho·∫£ng 1929‚Äì1933"],
  energy:["NƒÉng l∆∞·ª£ng gi√≥ ‚Äì m·∫∑t tr·ªùi","Th·ªßy ƒëi·ªán quy m√¥ l·ªõn","Kh√≠ t·ª± nhi√™n h√≥a l·ªèng (LNG)"],
  tech:["In 3D v√† robot c·ªông t√°c","Chu·ªói kh·ªëi (Blockchain)","V·ªá tinh ƒë·ªãnh v·ªã GPS"],
  field:["Du l·ªãch ‚Äì d·ªãch v·ª• s·ªë","H√†ng kh√¥ng d√¢n d·ª•ng","N√¥ng nghi·ªáp h·ªØu c∆°"],
  keyword:["S·ªë h√≥a d·ªØ li·ªáu","K·∫øt n·ªëi v·∫°n v·∫≠t","T·ª± ch·ªß AI"],
  achievement:["M√°y bay ph·∫£n l·ª±c th∆∞∆°ng m·∫°i","Vaccine c√¥ng ngh·ªá mRNA","ƒêi·ªán tho·∫°i th√¥ng minh"],
  impact:["TƒÉng th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠","Kinh t·∫ø tri th·ª©c n·ªïi l√™n","T·ª± ƒë·ªông h√≥a logistics"]
};

/* ========= TI·ªÜN √çCH ========= */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const menu=$("#menu");
let activeCell=null,timerRef=null,seconds=0,started=false;
let currentPlayer="", leaderboard=[];

const shuffle=a=>{const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}
const formatTime=s=>`${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;

function announce(msg){$("#liveRegion").textContent=msg;}
function startTimer(){ if(started) return; started=true; timerRef=setInterval(()=>{seconds++;$("#timer").textContent="üïí "+formatTime(seconds)},1000); }
function stopTimer(){ clearInterval(timerRef); started=false; }
function resetTimer(){ stopTimer(); seconds=0; $("#timer").textContent="üïí 00:00"; }

function lockBoard(lock){
  const tbl=$("#tbl");
  if(lock){ tbl.classList.add("locked"); $$("td.select").forEach(td=>td.style.pointerEvents="none"); }
  else { tbl.classList.remove("locked"); $$("td.select").forEach(td=>td.style.pointerEvents="auto"); }
}

function optionsForRow(k){return shuffle([...(ANSWERS[k]||[]),...(DISTRACTORS[k]||[])])}
function openMenuFor(c){
  if($("#tbl").classList.contains("locked")) return;
  activeCell=c;
  const k=c.closest("tr").dataset.row;
  const opts=optionsForRow(k);
  let html=`<h4>Ch·ªçn n·ªôi dung:</h4>`;
  html+=opts.map(v=>`<div class='opt' role="option" data-val="${v.replace(/"/g,"&quot;")}">${v}</div>`).join('');
  html+=`<div class='actions'><div class='chip' data-act='clear'>X√≥a √¥</div><div class='chip' data-act='close'>ƒê√≥ng</div></div>`;
  menu.innerHTML=html;
  const r=c.getBoundingClientRect();
  let top=r.bottom+10,left=r.left;
  const mw=Math.min(560,window.innerWidth-24);
  if(top+420>window.innerHeight)top=r.top-420;
  if(left+mw>window.innerWidth)left=window.innerWidth-mw-12;
  if(left<12)left=12;
  Object.assign(menu.style,{top:`${top}px`,left:`${left}px`,display:"block"});
}
function closeMenu(){menu.style.display="none";}
function setCellValue(c,v){ c.textContent=v; c.classList.remove("placeholder","correct","wrong"); }
function clearCell(c){ c.textContent="Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ"; c.classList.add("placeholder"); c.classList.remove("correct","wrong"); }
function clearAll(){ $$("#tbl td.select").forEach(clearCell); }

function computeAndRenderScore(){
  stopTimer();
  let correct=0,total=0;
  $$("tbody tr").forEach(tr=>{
    const k=tr.dataset.row;
    const ans=ANSWERS[k];
    tr.querySelectorAll("td.select").forEach((td,i)=>{
      total++;
      const user=td.textContent.trim();
      const right=ans[i];
      if(user===right){
        td.classList.add("correct");
        td.classList.remove("wrong");
        correct++;
      } else {
        td.classList.add("wrong");
        td.classList.remove("correct");
        const shownUser = user && user!=="Ch·∫°m ƒë·ªÉ ch·ªçn ‚ñæ" ? user : "‚Äî";
        td.innerHTML = `<span style="text-decoration: line-through; color:var(--bad);">${shownUser}</span><br>
                        <span style="color:var(--ok); font-weight:bold;">${right}</span>`;
      }
    });
  });
  const pct=Math.round(correct/total*100);
  const time=formatTime(seconds);
  $("#score").textContent=`ƒêi·ªÉm: ${correct}/${total} ‚Ä¢ ${pct}% ‚Ä¢ Th·ªùi gian: ${time}`;
  return {pct, time};
}

/* ========= ƒê√ÅP √ÅN M·∫™U ========= */
function showAnswerKey(){
  $$("tbody tr").forEach(tr=>{
    const k=tr.dataset.row;
    const ans=ANSWERS[k];
    tr.querySelectorAll("td.select").forEach((td,i)=>{
      setCellValue(td,ans[i]);
      td.classList.add("correct");
    });
  });
  stopTimer();
  $("#score").textContent=`ƒê√°p √°n m·∫´u ‚Ä¢ Th·ªùi gian: ${formatTime(seconds)}`;
  announce("ƒê√£ hi·ªÉn th·ªã ƒë√°p √°n m·∫´u");
}

/* ========= FULLSCREEN ========= */
function toggleFs(){
  const e=document.documentElement;
  if(!document.fullscreenElement) e.requestFullscreen?.();
  else document.exitFullscreen?.();
}

/* ========= LEADERBOARD (LocalStorage) ========= */
function loadLeaderboard(){
  try{
    const raw=localStorage.getItem("cmcn_leaderboard");
    leaderboard = raw ? JSON.parse(raw) : [];
  }catch{ leaderboard=[]; }
  renderLeaderboard();
}
function saveLeaderboard(){
  try{ localStorage.setItem("cmcn_leaderboard", JSON.stringify(leaderboard)); }catch{}
}
function renderLeaderboard(){
  const rank=$("#rankList");
  if(!leaderboard.length){ rank.innerHTML = `<div class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</div>`; return; }
  rank.innerHTML = leaderboard
    .slice(0,20)
    .map((p,i)=>`<div class="rank"><span class="name">${i+1}. ${p.name}</span><span class="meta">${p.score}% ‚Ä¢ ${p.time}</span></div>`)
    .join("");
}
function addToLeaderboard(name,score,time){
  const stamp = new Date().toLocaleString();
  leaderboard.push({name,score,time,stamp});
  leaderboard.sort((a,b)=> b.score - a.score || a.time.localeCompare(b.time));
  saveLeaderboard();
  renderLeaderboard();
}
function clearLeaderboard(){
  leaderboard = [];
  saveLeaderboard();
  renderLeaderboard();
}

/* ========= HI·ªÜN L·ªäCH S·ª¨ ========= */
function openHistory(){
  const box=$("#historyList");
  if(!leaderboard.length){
    box.innerHTML = `<div class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</div>`;
  }else{
    box.innerHTML = `
      <table style="width:100%;border-collapse:collapse;font-size:16px">
        <thead>
          <tr style="background:#e3f2fd">
            <th style="text-align:left;padding:8px;border-bottom:1px solid #ccc">#</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #ccc">Ng∆∞·ªùi ch∆°i</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #ccc">ƒêi·ªÉm</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #ccc">Th·ªùi gian</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #ccc">Th·ªùi ƒëi·ªÉm</th>
          </tr>
        </thead>
        <tbody>
          ${leaderboard.map((p,i)=>`
            <tr>
              <td style="padding:8px;border-bottom:1px solid #eee">${i+1}</td>
              <td style="padding:8px;border-bottom:1px solid #eee">${p.name}</td>
              <td style="padding:8px;border-bottom:1px solid #eee">${p.score}%</td>
              <td style="padding:8px;border-bottom:1px solid #eee">${p.time}</td>
              <td style="padding:8px;border-bottom:1px solid #eee">${p.stamp||""}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }
  $("#historyModal").classList.add("active");
}

/* ========= MODAL NH·∫¨P T√äN + B√ÄN PH√çM ·∫¢O ========= */
const modal=$("#playerModal");
const nameInput=$("#playerName");
function buildVirtualKeyboard(){
  const keys="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_.‚Üê‚ê£".split("");
  const vk=$("#virtualKeyboard");
  vk.innerHTML="";
  keys.forEach(k=>{
    const btn=document.createElement("button");
    btn.className="key";
    btn.type="button";
    btn.textContent = (k==="‚ê£") ? "C√°ch" : k;
    btn.addEventListener("click",()=>{
      if(k==="‚Üê") nameInput.value = nameInput.value.slice(0,-1);
      else if(k==="‚ê£") nameInput.value += " ";
      else nameInput.value += k;
      nameInput.focus();
    });
    vk.appendChild(btn);
  });
}
function openNameModal(){
  modal.classList.add("active");
  nameInput.value="";
  nameInput.focus();
}
function closeNameModal(){ modal.classList.remove("active"); }

/* ========= MODAL REVIEW ========= */
function openReviewModal(summaryText){
  $("#reviewText").textContent = summaryText;
  $("#reviewModal").classList.add("active");
}
function closeReviewModal(){ $("#reviewModal").classList.remove("active"); }

/* ========= H√ÄNH VI N√öT ========= */
$$("td.select").forEach(td=>{
  td.addEventListener("click",e=>{ e.stopPropagation(); openMenuFor(td); });
  td.addEventListener("keydown",e=>{
    if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openMenuFor(td); }
  });
});
menu.addEventListener("click",e=>{
  const o=e.target.closest(".opt");
  const a=e.target.closest("[data-act]");
  if(o && activeCell){ setCellValue(activeCell,o.dataset.val); closeMenu(); }
  else if(a){
    if(a.dataset.act==="clear" && activeCell) clearCell(activeCell);
    closeMenu();
  }
});
document.addEventListener("click",e=>{ if(!menu.contains(e.target)) closeMenu(); });
document.addEventListener("keydown",e=>{ if(e.key==="Escape") closeMenu(); });

$("#btnFs").addEventListener("click",toggleFs);

/* B·∫Øt ƒë·∫ßu l·∫ßn ƒë·∫ßu: m·ªü modal nh·∫≠p t√™n */
$("#btnStart").addEventListener("click",()=>{
  if(started) return; // ƒëang ch∆°i th√¨ kh√¥ng
  openNameModal();
});

/* Ng∆∞·ªùi ch∆°i m·ªõi: ch·ªâ khi b·∫•m n√∫t n√†y m·ªõi th√™m ng∆∞·ªùi ch∆°i m·ªõi (quy tr√¨nh nh∆∞ Start) */
$("#btnNewPlayer").addEventListener("click",()=>{
  openNameModal();
});

/* X√°c nh·∫≠n t√™n ‚Üí reset b·∫£ng c≈© + m·ªü kh√≥a + b·∫Øt ƒë·∫ßu timer */
$("#btnConfirmName").addEventListener("click",()=>{
  currentPlayer = nameInput.value.trim() || "Ng∆∞·ªùi ch∆°i";
  closeNameModal();
  // Quy tr√¨nh y√™u c·∫ßu: reset to√†n b·ªô n·ªôi dung c·ªßa ng∆∞·ªùi ch∆°i c≈©
  clearAll();
  $("#score").textContent="ƒêi·ªÉm: ‚Äî";
  resetTimer();
  lockBoard(false);
  startTimer();
  announce(`B·∫Øt ƒë·∫ßu cho ng∆∞·ªùi ch∆°i ${currentPlayer}`);
});

/* Ph√≠m Enter trong input c≈©ng x√°c nh·∫≠n */
nameInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    $("#btnConfirmName").click();
  }
});

/* N·ªôp b√†i: ch·∫•m ƒëi·ªÉm + l∆∞u leaderboard + Review (kh√¥ng t·ª± th√™m ng∆∞·ªùi ch∆°i m·ªõi) */
$("#btnCheck").addEventListener("click",()=>{
  if($("#tbl").classList.contains("locked")) return; // ch∆∞a b·∫Øt ƒë·∫ßu
  const {pct, time} = computeAndRenderScore();
  addToLeaderboard(currentPlayer || "Ng∆∞·ªùi ch∆°i", pct, time);
  lockBoard(true); // k·∫øt th√∫c l∆∞·ª£t
  announce(`L∆∞·ª£t ch∆°i k·∫øt th√∫c. ƒêi·ªÉm ${pct}% trong ${time}.`);
  openReviewModal(`üë§ ${currentPlayer} ‚Ä¢ ƒêi·ªÉm: ${pct}% ‚Ä¢ Th·ªùi gian: ${time}`);
});

/* Review buttons */
$("#btnReviewClose").addEventListener("click", closeReviewModal);
$("#btnReviewHistory").addEventListener("click", ()=>{
  closeReviewModal();
  openHistory();
});
$("#btnReviewNew").addEventListener("click", ()=>{
  closeReviewModal();
  // ch·ªâ khi b·∫•m Ng∆∞·ªùi ch∆°i m·ªõi m·ªõi v√†o quy tr√¨nh th√™m ng∆∞·ªùi ch∆°i
  openNameModal();
});

/* ƒê√°p √°n m·∫´u: gi·ªØ nguy√™n h√†nh vi */
$("#btnShow").addEventListener("click",showAnswerKey);

/* Reset: x√≥a b√†i hi·ªán t·∫°i, d·ª´ng timer, kh√≥a b·∫£ng (KH√îNG ·∫£nh h∆∞·ªüng BXH) */
$("#btnReset").addEventListener("click",()=>{
  clearAll();
  resetTimer();
  $("#score").textContent="ƒêi·ªÉm: ‚Äî";
  lockBoard(true);
  announce("ƒê√£ reset. Nh·∫•n B·∫Øt ƒë·∫ßu ho·∫∑c Ng∆∞·ªùi ch∆°i m·ªõi ƒë·ªÉ nh·∫≠p t√™n v√† ch∆°i.");
});

/* L·ªãch s·ª≠: xem to√†n b·ªô k·∫øt qu·∫£ ng∆∞·ªùi ch∆°i */
$("#btnHistory").addEventListener("click", openHistory);
$("#btnHistoryClose").addEventListener("click", ()=>$("#historyModal").classList.remove("active"));

/* X√≥a to√†n b·ªô BXH */
$("#btnClearLB").addEventListener("click",()=>{
  if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô BXH? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")){
    clearLeaderboard();
    announce("ƒê√£ x√≥a to√†n b·ªô BXH.");
  }
});

/* Kh·ªüi t·∫°o */
(function init(){
  buildVirtualKeyboard();
  lockBoard(true);       // Kh√≥a tr∆∞·ªõc khi nh·∫≠p t√™n
  resetTimer();          // Hi·ªÉn th·ªã 00:00
  loadLeaderboard();     // N·∫°p BXH c≈© (LocalStorage)
})();
</script>
</body>
</html>
